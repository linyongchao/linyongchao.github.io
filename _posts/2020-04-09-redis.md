---
layout: post
title:  Redis 过期策略和内存淘汰策略
date:   2020-04-09 20:59:54
categories: Redis
---

* content
{:toc}

本文参考：[这里](https://blog.csdn.net/Shreck66/article/details/88665882)、[这里](https://www.cnblogs.com/kyoner/p/11919007.html)

## 过期策略

### 为什么要处理数据过期

1. 过期设置为程序逻辑的一部分，所以为了保证逻辑正确(不读取到过期数据)，不得不对缓存做数据过期处理
2. 过期数据对业务来说已是无用数据，但是却仍然占有服务资源(主要是内存和磁盘)，故处理过期数据，可使服务资源得到释放

### 常用数据过期策略

|策略|说明|优点|缺点|
|:-:|:-:|:-:|:-:|
|定时删除|根据键的过期时间设置定时器，超时即删除|删除及时，内存友好|CPU不友好|
|惰性删除|程序在取键时对键进行过期检查|CPU友好，只在取键时才可能触发删除当前键|内存不友好|
|定期删除|每隔一段时间执行一次限时限量的批量删除|比定时删除少占CPU，比惰性删除节约内存|-|

### Redis 过期策略

Redis 采用定期删除和惰性删除相结合的过期策略:   
使用定期删除策略可以更平滑的利用CPU和内存资源，但是会存在过期数据失效不及时的问题  
使用惰性删除策略加以辅助便可解决定期删除数据失效不及时的问题

* Redis在客户端获取数据时，首先判断数据是否设置过期时间；如果设置了过期时间，且当前时间大于过期时间则删除对应的key
* 默认情况下，Redis每秒执行一次定期删除，每次扫描10个库，每个库删除20个过期key

### Redis 持久化如何应对过期数据

1. RDB 持久化模式下
	* 生成RDB文件时: Redis会检查保存的数据是否过期，如果过期则不会写入RDB文件
	* 载入RDB文件时: Redis会对RDB文件中的数据进行过期检查，已过期的数据会被忽略，不写入内存

2. AOF 持久化模式下
	* 追加AOF文件时: 当有数据被删除，Redis会追加该删除命令倒AOF文件中去
	* 重写AOF文件时: 已过期的数据不会写入新AOF文件(重写文件体积压缩的原因之一)

### Redis slave 如何应对过期数据

slave 不主动对过期键进行删除，master 在处理过期键时会发送del命令给 slave，此时 slave 才会删除对应的过期键

* slave 为何不执行类似 master 的删除策略去处理过期键？
因为Redis需要保证主备机数据的一致性，如果各自处理过期数据，会造成数据不一致  
在极端情况下，例如主备发生分区，然后 master 对某个设置了过期时间的key执行了persist命令将其变为永久key，此时slave收不到主机的persist命令，当key过期时，备机将其移除。这种情况下就明显发生了主备不一致的现象
* 访问 slave 上的某个过期键，能获得结果么？
当客户端访问slave过期键时，slave不执行删除操作，但是会给客户端返回空



## 内存淘汰策略

|策略|含义|
|:-:|:-:|
|noeviction|不删除数据(但Redis会根据引用计数器进行释放),如果内存不够，写入会报错|
|volatile-ttl|从设置了过期时间的key中，选择更早过期时间的key移除|
|volatile-random|从设置了过期时间的key中，随机选择key进行移除|
|allkeys-random|从所有key中，随机选择key进行移除|
|volatile-lru|从设置了过期时间的key中，选择最少使用的key移除|
|allkeys-lru|从所有key中，选择最少使用的key移除|
|volatile-lfu|从设置了过期时间的key中，使用LFU算法移除key|
|allKeys-lfu|从所有key中，使用LFU算法移除key|

### LFU算法

LFU算法是Redis4.0里面新加的一种淘汰策略。它的全称是Least Frequently Used，它的核心思想是根据key的最近被访问的频率进行淘汰，很少被访问的优先被淘汰，被访问的多的则被留下来。

LFU算法能更好的表示一个key被访问的热度。  
假如你使用的是LRU算法，一个key很久没有被访问到，只刚刚是偶尔被访问了一次，那么它就被认为是热点数据，不会被淘汰，而有些key将来是很有可能被访问到的则被淘汰了。  
如果使用LFU算法则不会出现这种情况，因为使用一次并不会使一个key成为热点数据。

要注意的一点是这两周策略只能在Redis4.0及以上设置，如果在Redis4.0以下设置会报错

