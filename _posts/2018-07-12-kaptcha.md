---
layout: post
title:  Kaptcha
date:   2018-07-12 17:46:54
categories: Java
---

* content
{:toc}

### ç®€ä»‹
å¯ä»¥ç”¨æ¥ç”ŸæˆéªŒè¯ç   
å®˜æ–¹æ•ˆæœå¦‚ä¸‹ï¼š  
æ°´çº¹æ•ˆæœï¼š  
![æ°´çº¹](http://7tszu0.com1.z0.glb.clouddn.com/WaterRipple.png 'æ°´çº¹')   
![æ°´çº¹](http://7tszu0.com1.z0.glb.clouddn.com/WaterRipple-NoNoise.png 'æ°´çº¹æ— å¹²æ‰°çº¿')  
é±¼çœ¼æ•ˆæœï¼ˆæœ‰æ— å¹²æ‰°çº¿çœ‹ä¸å‡ºæ¥ğŸ˜“ï¼‰ï¼š  
![é±¼çœ¼](http://7tszu0.com1.z0.glb.clouddn.com/FishEyeGimpy.png 'é±¼çœ¼')   
![é±¼çœ¼](http://7tszu0.com1.z0.glb.clouddn.com/FishEyeGimpy-NoNoise.png 'é±¼çœ¼æ— å¹²æ‰°çº¿')  
é˜´å½±æ•ˆæœï¼š  
![é˜´å½±](http://7tszu0.com1.z0.glb.clouddn.com/ShadowGimpy.png 'é˜´å½±')   
![é˜´å½±](http://7tszu0.com1.z0.glb.clouddn.com/ShadowGimpy-NoNoise.png 'é˜´å½±æ— å¹²æ‰°çº¿') 
### å®‰è£…

	<!-- https://mvnrepository.com/artifact/com.google.code.kaptcha/kaptcha -->
	<dependency>
	    <groupId>com.google.code.kaptcha</groupId>
	    <artifactId>kaptcha</artifactId>
	    <version>2.3</version>
	</dependency>

jaråŒ…ä¸‹è½½è§[è¿™é‡Œ](http://7xiqe6.com1.z0.glb.clouddn.com/kaptcha-2.3.jar)  
æºç ä¸‹è½½è§[è¿™é‡Œ](http://7xiqe6.com1.z0.glb.clouddn.com/kaptcha-2.3.2-sources.jar)

### å±æ€§åˆ—è¡¨

| å±æ€§ | æè¿° | é»˜è®¤å€¼ |
|:---:|:---:|:---:|
|kaptcha.border|å›¾ç‰‡è¾¹æ¡†ï¼šyes , no| yes|
|kaptcha.border.color|è¾¹æ¡†é¢œè‰²ï¼š r,g,b æˆ–è€… white,black,blue| black |
|kaptcha.border.thickness|è¾¹æ¡†åšåº¦ï¼š> 0|1|
|kaptcha.image.width|å›¾ç‰‡å®½åº¦| 200|
|kaptcha.image.height|å›¾ç‰‡é«˜åº¦|50|
|kaptcha.producer.impl|å›¾ç‰‡å®ç°ç±»|com.google.code.kaptcha.impl.DefaultKaptcha|
|kaptcha.textproducer.impl|æ–‡æœ¬å®ç°ç±»|com.google.code.kaptcha.text.impl.DefaultTextCreator|
|kaptcha.textproducer.char.string|æ–‡æœ¬é›†åˆï¼ŒéªŒè¯ç å¯é€‰å€¼|abcde2345678gfynmnpwx|
|kaptcha.textproducer.char.length|éªŒè¯ç é•¿åº¦|	5|
|kaptcha.textproducer.font.names|å­—ä½“|Arial, Courier|
|kaptcha.textproducer.font.size|å­—ä½“å¤§å°|	40|
|kaptcha.textproducer.font.color|å­—ä½“é¢œè‰²ï¼š r,g,b  æˆ–è€… white,black,blue| black |
|kaptcha.textproducer.char.space|æ–‡å­—é—´éš”|2|
|kaptcha.noise.impl|å¹²æ‰°å®ç°ç±»|com.google.code.kaptcha.impl.DefaultNoise|
|kaptcha.noise.color|å¹²æ‰°é¢œè‰²ï¼š r,g,b æˆ–è€… white,black,blue.| black |
|kaptcha.obscurificator.impl|å›¾ç‰‡æ ·å¼ï¼š<br>æ°´çº¹com.google.code.kaptcha.impl.WaterRipple é±¼çœ¼com.google.code.kaptcha.impl.FishEyeGimpy é˜´å½±com.google.code.kaptcha.impl.ShadowGimpy|com.google.code.kaptcha.impl.WaterRipple|
|kaptcha.background.impl|èƒŒæ™¯å®ç°ç±»|com.google.code.kaptcha.impl.DefaultBackground|
|kaptcha.background.clear.from|èƒŒæ™¯é¢œè‰²æ¸å˜ï¼Œå¼€å§‹é¢œè‰²|	light grey|
|kaptcha.background.clear.to|èƒŒæ™¯é¢œè‰²æ¸å˜ï¼Œç»“æŸé¢œè‰²| white |
|kaptcha.word.impl|æ–‡å­—æ¸²æŸ“å™¨|com.google.code.kaptcha.text.impl.DefaultWordRenderer|
|kaptcha.session.key|session key|KAPTCHA_SESSION_KEY|
|kaptcha.session.date|session date|KAPTCHA_SESSION_DATE|

### ç‰¹æ®Šé…ç½®

	#å»é™¤å¹²æ‰°çº¿
	<prop key="kaptcha.noise.impl">com.google.code.kaptcha.impl.NoNoise</prop>
	#å­—ä½“
	<prop key="kaptcha.textproducer.font.names">å®‹ä½“,æ¥·ä½“,å¾®è½¯é›…é»‘</prop>

### å­˜å‚¨ä½ç½®

ä½¿ç”¨é»˜è®¤çš„```com.google.code.kaptcha.servlet.KaptchaServlet```äº§ç”Ÿçš„éªŒè¯ç å€¼å­˜å‚¨äº session ä¸­ï¼Œåœ¨æŸäº›ç¯å¢ƒä¸‹æ˜¯ä¸é€‚ç”¨çš„ï¼Œæ¯”å¦‚ä¸ä½¿ç”¨ session åŒæ­¥çš„ Tomcat é›†ç¾¤  
å¯åŸºäºæºç ä¿®æ”¹å­˜å‚¨ä½ç½®æ»¡è¶³éœ€æ±‚
	
	public class KaptchaServlet extends HttpServlet implements Servlet {
	    private Properties props = new Properties();
	    private Producer kaptchaProducer = null;
	    private String sessionKeyValue = null;
	
	    public KaptchaServlet() {
	    }
	
	    public void init(ServletConfig conf) throws ServletException {
	        super.init(conf);
	        ImageIO.setUseCache(false);
	        Enumeration initParams = conf.getInitParameterNames();
	
	        while(initParams.hasMoreElements()) {
	            String key = (String)initParams.nextElement();
	            String value = conf.getInitParameter(key);
	            this.props.put(key, value);
	        }
	
	        Config config = new Config(this.props);
	        this.kaptchaProducer = config.getProducerImpl();
	        this.sessionKeyValue = config.getSessionKey();
	    }
	
	    public void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
	        resp.setDateHeader("Expires", 0L);
	        resp.setHeader("Cache-Control", "no-store, no-cache, must-revalidate");
	        resp.addHeader("Cache-Control", "post-check=0, pre-check=0");
	        resp.setHeader("Pragma", "no-cache");
	        resp.setContentType("image/jpeg");
	        String capText = this.kaptchaProducer.createText();
	        # å°† capText çš„å­˜å‚¨ä½ç½®ä¿®æ”¹ï¼Œæ¯”å¦‚å­˜å…¥ Redis
	        req.getSession().setAttribute(this.sessionKeyValue, capText);
	        BufferedImage bi = this.kaptchaProducer.createImage(capText);
	        ServletOutputStream out = resp.getOutputStream();
	        ImageIO.write(bi, "jpg", out);
	
	        try {
	            out.flush();
	        } finally {
	            out.close();
	        }
	
	    }
	}