---
layout: post
title:  ZooKeeper CAP
date:   2020-04-09 15:59:54
categories: ZooKeeper
---

* content
{:toc}

本文参考：[这里](https://www.jianshu.com/p/e342b00745e6)、[这里](https://blog.csdn.net/yanpenglei/article/details/80362561)

### CAP

CAP 是指：一致性 Consistency、可用性 Availablity、分区容错性 Partition Tolerance

* 一个分布式系统无法同时满足以上三个需求，因此在实际运用时，就要抛弃其中一项
* CAP定理应用：
	1. 放弃P:放弃P就意味着放弃了扩展性。就是把所有数据放在一个节点上，就不是分布式了
	2. 放弃A:系统遇到故障时，在等待时间内系统无法对外提供正常服务，即不可用
	3. 放弃C:放弃强一致性，而保持数据的最终一致性。引入**时间窗口**概念
* 对于分布式系统而言，网络问题是必定会出现的异常情况
* 因为P是一个分布式系统必须面对和解决的问题，所以往往要根据业务权衡C和A之间的选择

![CAP](https://linyongchao.github.io/static/img/zookeeper/cap.png)

ZooKeeper 保证的是 CP  
Eureka 保证的是 AP

### 一致性（C:Consistency）

在分布式环境中，一致性是指数据在多个副本之间是否能够保持数据一致的特性。  
在一致性的需求下，当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。  
例如一个将数据副本分布在不同分布式节点上的系统来说，如果对第一个节点的数据进行了更新操作并且更新成功后，其他节点上的数据也应该得到更新，并且所有用户都可以读取到其最新的值，那么这样的系统就被认为具有强一致性（或严格的一致性，最终一致性）。

### 可用性（A:Available）

可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。  
“有效的时间内”是指，对于用户的一个操作请求，系统必须能够在指定的时间（即响应时间）内返回对应的处理结果，如果超过了这个时间范围，那么系统就被认为是不可用的。  
“返回结果”是可用性的另一个非常重要的指标，它要求系统在完成对用户请求的处理后，返回一个正常的响应结果。正常的响应结果通常能够明确的反映出对请求的处理结果，即成功或失败，而不是一个让用户感到困惑的返回结果。

### 分区容错性（P:Partition Tolerance）

分区容错性约束了一个分布式系统需要具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。  
网络分区是指在分布式系统中，不同的节点分布在不同的子网络（机房或异地网络等）中，由于一些特殊的原因导致这些子网络之间出现网络不连通的状况，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成了若干个孤立的区域。需要注意的是，组成一个分布式系统的每个节点的加入与退出都可以看作是一个特殊的网络分区。

### ZooKeeper 的缺陷

由于 ZooKeeper 保证了 CP，那么必然有放弃 A 的缺陷：

* 不能保证每次服务请求的可用性。任何时刻对ZooKeeper的访问请求能得到一致的数据结果，同时系统对网络分割具备容错性；但是它不能保证每次服务请求的可用性（注：也就是在极端环境下，ZooKeeper可能会丢弃一些请求，消费者程序需要重新请求才能获得结果）。所以说，ZooKeeper不能保证服务可用性。

* 进行leader选举时集群都是不可用。在使用ZooKeeper获取服务列表时，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30 ~ 120s, 且选举期间整个zk集群都是不可用的，这就导致在选举期间注册服务瘫痪，虽然服务能够最终恢复，但是漫长的选举时间导致的注册长期不可用是不能容忍的。所以说，ZooKeeper不能保证服务可用性。

